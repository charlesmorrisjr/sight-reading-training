<!DOCTYPE html>
<!-- saved from url=(0052)https://paulrosen.github.io/abcjs/examples/wrap.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="https://paulrosen.github.io/abcjs/examples/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="./abcjs_ Basic Demo - Line Wrap_files/examples-styles.css">

  <title>AbcJS: Random Music Generator</title>
  <script src="abcjs-basic-min.js" type="text/javascript"></script>
  <script type="text/javascript">
	  let abc = "T: Cooley's\n" +
		  "%%measurenb 1\n" +
		  "M: 4/4\n" +
		  "L: 1/8\n" +
		  "R: reel\n" +
		  "K: Emin\n" +
		  "FB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|\n" +
		  "EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2D2|\n" +
		  "EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|\n" +
		  "EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2gf|\n" +
		  "eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|\n" +
		  "eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2gf|\n" +
		  "eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|\n" +
		  "eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2|]";

    let minSpacing = 1.8;
    let maxSpacing = 2.8;
    let preferredMeasuresPerLine = 4;
    let staffwidth = 900;
    let musicKey = 'C';
    let musicLength = 8;

        
    /**
     * Generates a random ABC notation string
     * @param {number} measures - Number of measures to generate
     * @param {string} key - Musical key (e.g., 'C', 'G', 'D', 'Am', 'Em')
     * @returns {string} ABC notation string
     */
    
     /* TODO:
      * - Make all keys available
      *   - Add sharps and flats to keys
      *   - May have to switch to button selectors so user can't select impossible keys
      * - Make length changeable
      * - Add half notes and whole notes
      *   - Notes should be selectable eventually
      * - Make time signature changeable
     */
    
    /* Algo to select available note intervals
    * - Object containing boolean states for interval options
    * - Have checkboxes (eventually label toggles) to select necessary intervals
    * - Music generation algo should check checkboxes to determine which intervals to generate
    * 
    * - determine interval checkboxes selected
    *   - create array of possible intervals
    *   - randomly select interval
    *   - add interval to last note and use modulo of 7 to select the correct note from the 'notes' array
    */
    
    
    function generateRandomABC(measures = 8, key = 'C') {
      // Basic ABC header
      let abc = `X:1\nT:Random Tune\nM:4/4\nL:1/8\nK:${key}\n`;
      
      // Available notes based on key
      // ^ is sharp, _ is flat
      const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

      // Determine interval checkboxes selected and create an array of the available intervals
      let intervals = [1];
      for (let i = 2; i <= 8; i++) {
        const checkbox = document.getElementById(`interval${i}`);
        if (checkbox && checkbox.checked) {
          intervals.push(i);
        }
      }
     
      // Generate measures
      for (let i = 0; i < measures; i++) {
        let lastNoteIndex = 0; // Start at C
        let octaveLower = false;
        let measure = notes[lastNoteIndex]; // Start measure with C
        let beats = 1; // Already added one note
        
        // Fill measure with random notes
        while (beats < 8) { // 4/4 time signature
          // Randomly select interval
          let interval = intervals[Math.floor(Math.random() * intervals.length)] - 1;
          // Randomly change interval to negative so notes can go downward
          interval = Math.random() < 0.5 ? -interval: interval;
          // Save index without modulo operation to determine what octave the note should be placed in
          let nextNoteIndex = lastNoteIndex + interval;
          if (nextNoteIndex < 0) {
            octaveLower = true;
          }
          // Save the raw index of this note to determine the interval for the next note
          lastNoteIndex = lastNoteIndex + interval;
          // Set next note (use modulo to wrap around the notes array)
          let nextNote = notes[((lastNoteIndex % 7) + 7) % 7];
          // If note belongs in octave below, place it there.
          if (octaveLower) {
            nextNote = nextNote + ",";
            octaveLower = false;
          // If note belongs in octave above, place it there.
          } else if (nextNoteIndex >= 7) {
            nextNote = nextNote.toLowerCase();
          }
          
          const duration = Math.random() < 0.3 ? 2 : 1; // 30% chance of quarter note
          
          // Add note to measure
          measure += nextNote;
          // If the note is an quarter note, add a space
          if (duration === 2) {
            measure += '2';
            beats += 2;
          } else {
            beats += 1;
          }
          
          // If the previous note is a quarter note, add a space
          if (measure.slice(-1) === '2') {
            measure += ' ';
          }
        }
        
        abc += measure + '|';
        if (i % 2 === 1) abc += '\n'; // Add line break every 2 measures
      }
      
      return abc;
    }

    // Example usage:
    // console.log(generateRandomABC(8, 'C')); 

    function redraw() {
      abc = generateRandomABC(musicLength, musicKey);
      console.log(abc);
      
      ABCJS.renderAbc("paper", abc, {
        wrap: {
          minSpacing: minSpacing,
          maxSpacing: maxSpacing,
          preferredMeasuresPerLine: preferredMeasuresPerLine
        },
        staffwidth: staffwidth
      });
    }
    
    function load() {
      let el = document.querySelector("#parameters");
      el.addEventListener("submit", changeParameters);
      redraw();
    }

    function changeParameters(ev) {
      ev.preventDefault();
      let data = new FormData(ev.target);
      
      minSpacing = data.get("min");
      maxSpacing = data.get("max");
      preferredMeasuresPerLine = data.get("measures");
      staffwidth = data.get("width");
      musicKey = data.get("musicKey").toUpperCase();
      musicLength = data.get("musicLength");
      
      redraw();
    }

  </script>
  <style>
    #paper {
      display: flex;
      justify-content: center;
      width: auto;
    }
    form {
      margin: 0 auto 30px auto;
      max-width: 800px;
		display: flex;
    }
    label {
      margin: 0 3px;
    }
  </style>
</head>
<body onload="load()">
  <header>
    <h1>Random Music Generator</h1>
  </header>
    <form id="parameters">
      <label>Total width: <input id="width" name="width" type="number" min="300" max="2000" step="10" value="900"></label>
      <label>Preferred measures per line: <input id="measures" name="measures" type="number" min="0" max="32" step="1" value="4"></label>
      <label>Key: <input id="musicKey" name="musicKey" type="text" value="C"></label>
      <label>Measures: <input id="musicLength" name="musicLength" type="number" min="1" max="32" step="1" value="8"></label>
      <button type="submit">Redraw</button>
    </form>
    <form id="intervals">
      <label><input type="checkbox" id="interval2" name="interval2" value="2"> 2nd</label>
      <label><input type="checkbox" id="interval3" name="interval3" value="3"> 3rd</label>
      <label><input type="checkbox" id="interval4" name="interval4" value="4"> 4th</label>
      <label><input type="checkbox" id="interval5" name="interval5" value="5"> 5th</label>
      <label><input type="checkbox" id="interval6" name="interval6" value="6"> 6th</label>
      <label><input type="checkbox" id="interval7" name="interval7" value="7"> 7th</label>
      <label><input type="checkbox" id="interval8" name="interval8" value="7"> 8th</label>
    </form>
  <div id="paper"></div>


</body></html>